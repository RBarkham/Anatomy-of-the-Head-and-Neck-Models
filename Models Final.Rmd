---
title: "Cadaveric Study of the branches of the External Carotid Artery (ECA)"
author: "Ryan Barkham"
date: "2025-11-06"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```


First, lets load the packaged required to run this model
```{r}
library(tidyverse)
library(lme4)
library(lmtest)
library(car)
library(knitr)
library(emmeans)
library(gt)

```


# _Loading our data:_
Here we're loading our data, and wrangleing it so its ready for analysis.
```{r, message=FALSE}
data = read_csv("ECA_variant_dataset_with_types.csv") %>% 
  mutate(Sex = as.factor(sex), 
         Side = as.factor(side), 
         Variant_present = as.factor(variant_present),
         Variant_type = as.factor(variant_type),
         .keep = "unused")

#First we load the data, and correctly categorise the data types as factors
```


Create a separate object, containing only variants, and removing the "no variant" option which optimizes use for linear model
```{r}
variant_selected = data %>% filter(Variant_present == "yes") %>% 
  droplevels()
## droplevels() removes any unused factors (such as type 0) from our dataset of variants
```

# _Diameter_
Create linear model for diameter + ANOVA
```{r}

Variant_diameter_lm = lm(diameter_mm ~ Side 
                              + Sex 
                              + Variant_type 
                              + Side:Sex
                              + Side:Variant_type,
                              data = variant_selected)

### The first row isn't important re significance, the first row is the reference and any significant just tells us that it isn't 0 

### #we're considering not just the effects that Sex, Side and Type may have on diameter, but also how they may interact with one another to jointly affect diameter
```

Lets test if our model meets our assumptions, to ensure its fit for purpose
```{r}

shapiro.test(residuals(Variant_diameter_lm)) #Test normaility


bptest(Variant_diameter_lm) #Test equal variance 


dwtest(Variant_diameter_lm) #Test for independence
```
### we can see our model meets the assumptions
#
#
```{r}
Anova(Variant_diameter_lm, type = "III")
```

## Tukey's Post Hoc test (diameter)
```{r}
Variant_diameter_emmeans = emmeans(Variant_diameter_lm, "Sex")

Variant_diameter_pairs = pairs(Variant_diameter_emmeans)

confint(Variant_diameter_pairs)

#this compares the difference between mean values, to test if there is an actual difference)

```







#
#
#
#
# _Distance_
### Creating linear model for distance + ANOVA
```{r}
Variant_distance_lm = lm(distance_mm ~ Side 
                              + Sex 
                              + Variant_type 
                              + Side:Sex
                              + Side:Variant_type,
                              data = variant_selected)

```

### Lets test if it meets our assumptions, to ensure it's fit for purpose
```{r}
shapiro.test(residuals(Variant_distance_lm)) #Test normality


bptest(Variant_distance_lm) #Test equal variance 


dwtest(Variant_distance_lm) #Test for independence
```
### we can see our model meets the assumptions
#
#

```{r}
Anova(Variant_distance_lm, type = "III")
```

### Tukey's post hoc test for distance
```{r}
emmeans_Variant_distance_lm = emmeans(Variant_distance_lm, "Sex")

pairs_Variant_distance_lm = pairs(emmeans_Variant_distance_lm)

confint(pairs_Variant_distance_lm)

```



### _(Optional) Understanding the impact of applying a randomising effect, for a mixed model_ 
#### The mixed model can be found below, notice the errors which arise when we add (1|cadaver_id)
```{r}
library(DHARMa)
lmer_model <- lmer(diameter_mm 
               ~ Sex
               * Side 
               + Variant_type
               + Variant_type:Sex
               + Side:Sex
               +(1|cadaver_id)
               , data=variant_selected)
```
#### Note the convergence errors and singular fit warnings observed. In this case, the random intercept is unidentifiable, and our model is not fit for purpose. We can also tell thisfrom the anova tablw which does not highlight the first row as significant where correct models would.


```{r}
# Simulate residuals, to further test our model
sim_res <- simulateResiduals(fittedModel = lmer_model, n = 1000)

shapiro.test(residuals(lmer_model))

# Test for normality
testUniformity(sim_res)

# Test for equal variance
testDispersion(sim_res)

# Test for temporal/autocorrelation
testResiduals(sim_res)

summary(lmer_model)
```

