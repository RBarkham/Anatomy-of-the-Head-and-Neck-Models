---
title: "Code for model development"
author: "Ryan Barkham"
date: "2025-11-05"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(tidyverse)
library(gt)
library(emmeans)
library(lme4)

### This just loads some programs to use
```
### Loading our data
```{r, message=FALSE}
data = read_csv("ECA_variant_dataset_with_types.csv") %>% 
  mutate(Sex = as.factor(sex), 
         Side = as.factor(side), 
         Variant_present = as.factor(variant_present),
         Variant_type = as.factor(variant_type),
         .keep = "unused")

#First we load the data, and correctly categorise the data types as factors
```

```{r}
variant_selected = data %>% filter(Variant_present == "yes") %>% 
  droplevels()
## droplevels() removes any unused factors (such as type 0) from our dataset of variants
```



### ANOVA for diameter 
```{r}
#distance Type:Side, no p value

Variant_diameter_lm = lm(diameter_mm ~ Side 
                              + Sex 
                              + Variant_type 
                              + Side:Sex
                              + Side:Variant_type,
                              data = variant_selected)

plot(Variant_diameter_lm)

summary(Variant_diameter_lm)

anova(Variant_diameter_lm)

### The first row isn't important re significance, the first row is the reference and any significant just tells us that it isn't 0 ###
```


### Tukey's Post Hoc test (diameter)
```{r}
Variant_diameter_emmeans = emmeans(Variant_diameter_lm, "Sex") # we can disregard the warning message, as we have accounted for interactions

Variant_diameter_pairs = pairs(Variant_diameter_emmeans)

confint(Variant_diameter_pairs)

#this compares the difference between mean values, to test if there is an actual difference)

```


## ANOVA for distance
```{r}
Variant_distance_lm = lm(distance_mm ~ Side 
                              + Sex 
                              + Variant_type 
                              + Side:Sex
                              + Side:Variant_type,
                              data = variant_selected)

plot(Variant_distance_lm)

summary(Variant_distance_lm)

anova(Variant_distance_lm)
```

### Tukey's post hoc test for distance
```{r}
emmeans_Variant_distance_lm = emmeans(Variant_distance_lm, ~ Side | Sex)
pairs_Variant_distance_lm = pairs(emmeans_Variant_distance_lm)

confint(pairs_Variant_distance_lm)

```












### optional: Model with fixed effects


```{r}
#By adding (1 | cadaver_id) we add a randomization effect, making this a mixed model.
lmer_dia_sex_side = lmer(diameter_mm ~ Side 
                              + Sex 
                              + Variant_type 
                              + Side:Sex
                              + Side:Variant_type
                              +(1 | cadaver_id),
                              data = variant_selected) 

plot(lmer_dia_sex_side)


hist(residuals(lmer_dia_sex_side))

summary(lmer_dia_sex_side)

```

```{r}
lmer_dis_sex_side = lmer(distance_mm ~ Side 
                              + Sex 
                              + Variant_type 
                              + Side:Sex
                              + Side:Variant_type
                              + (1 | cadaver_id),
                              data = variant_selected)

plot(lmer_dis_sex_side)

hist(residuals(lmer_dis_sex_side))

summary(lmer_dis_sex_side)

```

#### Note the convergence errors and singular fit warnings observed. In this case, the random intercept is unidentifiable, and our model is not fit for purpose. We can also tell this from the anova tablw which does not highlight the first row as significant where ccorrect models would.